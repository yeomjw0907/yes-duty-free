# 다음 기능 검토: 소셜 로그인 · PG 연동 및 권장 항목

**검토 일자:** 2025-02-10  
**전제:** 소셜 로그인 + PG사(Stripe) 연동을 다음 단계로 진행한다고 가정.

---

## 1. 다음 단계로 예정된 기능

| 항목 | 내용 | 비고 |
|------|------|------|
| **소셜 로그인** | Google, Apple 등 OAuth | Supabase Auth `signInWithOAuth` 연동 |
| **PG 연동** | Stripe | 문서상 대만/해외 카드용 Stripe 단일 연동 확정 |

---

## 2. PG 연동 시 함께 필요해 보이는 것

현재 주문 생성(`createOrder`)은 **결제 없이** `orders`에 `payment_status: 'pending'`, `paid_at: null`로 넣고 끝납니다. PG 연동 시 아래가 필요합니다.

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| **결제 창/리다이렉트 흐름** | 주문서 "결제하기" → Stripe Checkout 또는 Payment Element → 결제 완료 후 복귀 | 필수 |
| **결제 완료 시 DB 반영** | 결제 성공 시 해당 주문의 `payment_status = 'paid'`, `paid_at = now()` 업데이트 | 필수 |
| **Stripe Webhook** | 결제 성공/실패/환불 등 이벤트 수신 → 주문/결제 상태 동기화 (클라이언트 실패 대비) | 강력 권장 |
| **결제 실패 처리** | 결제 실패 시 사용자 메시지, 필요 시 주문은 "결제대기" 유지 또는 일정 시간 후 자동 취소 정책 | 권장 |
| **환불 연동** | 관리자에서 "환불 처리" 시 Stripe Refund API 호출 + `payment_status = 'refunded'` 등 반영 | 추후 |

구현 시 참고: `lib/api/orders.ts`에 `updateOrderPaymentStatus(orderId, { payment_status, paid_at })` 같은 함수를 두고, Stripe 결제 완료 콜백/웹훅에서 호출하면 됩니다.

---

## 3. 소셜 로그인 시 함께 있으면 좋은 것

| 항목 | 설명 | 우선순위 |
|------|------|----------|
| **최초 소셜 가입 시 프로필 생성** | Supabase `onAuthStateChange` 또는 회원가입 시점에 `upsertUserProfile` 호출(이메일·이름은 provider에서) | 필수 |
| **기존 이메일 계정과 연동** | 같은 이메일로 이메일 가입 후 소셜 로그인 시 계정 병합 여부 정책 (선택) | 선택 |

이미 `useAuth`에서 `getProfile`로 프로필을 쓰고, `signUp`에서 `upsertUserProfile`을 호출하므로, 소셜 로그인 최초 로그인 시에도 동일하게 프로필 생성/갱신만 해주면 됩니다.

---

## 4. 인증/계정 쪽 추가 권장

| 항목 | 현재 상태 | 권장 |
|------|-----------|------|
| **비밀번호 찾기** | 로그인 페이지에 "비밀번호 찾기" 버튼만 있음, 동작 없음 | Supabase `resetPasswordForEmail` + 이메일 발송 후 리셋 페이지 연결 |
| **이메일 인증** | 미확인 | Supabase 이메일 확인 설정 시, 가입 후 확인 유도 UI/리다이렉트 |

---

## 5. 주문/고객 경험

| 항목 | 현재 상태 | 권장 |
|------|-----------|------|
| **주문 취소(사용자)** | 상태값 `취소접수`는 있으나, 사용자가 "주문 취소 요청"하는 API/UI 없음 | 결제 전 주문: "취소 요청" 버튼 → 상태를 `취소접수`로 변경 등 |
| **환불 요청(사용자)** | 반품접수 등 사용자 측 플로우 없음 | 정책에 따라 "반품/환불 요청" 폼 + 관리자에서 처리 (PG 환불은 2번과 연동) |

---

## 6. 그 외 참고 (기존 문서/TODO 기준)

- **포인트/적립금 사용 내역** – TODO에 "추후 검토"로 있음. 마이페이지에서 포인트 변동 내역 노출 시 신뢰도 상승.
- **실시간 알림** – Supabase Realtime 등으로 "주문 접수/배송 변경" 알림 (선택).
- **이메일 알림** – 주문 접수, 결제 완료, 배송 출고 등 (선택, Supabase Edge Functions + 이메일 서비스 등).

---

## 7. 우선순위 제안

1. **PG 연동 (Stripe)**  
   - 결제 창/리다이렉트 → 결제 완료 시 `paid_at`·`payment_status` 반영 → (가능하면) Webhook.
2. **소셜 로그인**  
   - OAuth 연동 + 최초 로그인 시 `upsertUserProfile` 호출.
3. **비밀번호 찾기**  
   - 이메일 로그인 사용자 위해 "비밀번호 찾기" 동작 구현.
4. **주문 취소(사용자)**  
   - 결제 전 주문에 한해 취소 요청 API + UI.
5. 그 다음: 환불 연동, 포인트 내역, 이메일/실시간 알림 등은 필요에 따라 단계적으로.

이 순서로 하면 소셜 로그인·PG 연동을 중심으로, 필수·권장 항목이 함께 정리됩니다.
